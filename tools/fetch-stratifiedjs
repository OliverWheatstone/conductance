#!/usr/bin/env sjs

var { dirname } = require('path');
var { exec    } = require('sjs:nodejs/child-process');
var { read    } = require('sjs:nodejs/stream');
var fs = require('sjs:nodejs/fs');

// make sure we're in the right directory
process.chdir("#{dirname(process.argv[0])}/..");

if (fs.exists('stratifiedjs/.git')) {
  console.log('stratifiedjs directory already contains a git repository -> exiting');
  process.exit(1);
}

if (exec('git status --porcelain stratifiedjs').stdout.length) {
  console.log('stratifiedjs directory not clean -> exiting');
  process.exit(1);
}

console.log("\
Replacing directory '#{fs.realpath('stratifiedjs')}' with github repository at git://github.com/onilabs/stratifiedjs.git.
Sure you want to proceed? [y/N]");
if (read(process.stdin).toString().toLowerCase() != 'y\n') {
  console.log('-> exiting');
  process.exit(1);
}

exec('rm -rf stratifiedjs/');
console.log('Cloning external repo');
exec('git clone git://github.com/onilabs/stratifiedjs.git stratifiedjs');
console.log("Checking out branch 'mho'");
exec('cd stratifiedjs/; git checkout mho');
console.log('Reapplying out patches');
exec('git checkout -- stratifiedjs/');
console.log('ALL DONE');
